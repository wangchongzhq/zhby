name: Convert M3U to TXT Daily

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'ipvym3a'
      - 'ipzy.m3u'
      - 'iptv.m3a'
      - 'convert_m3u_to_txt.py'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Convert M3U to TXT
      run: |
        echo "å¼€å§‹è½¬æ¢M3Uæ–‡ä»¶..."
        python convert_m3u_to_txt.py
        echo "=== è½¬æ¢å®Œæˆ ==="
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la *.txt
        echo "=== æ–‡ä»¶å†…å®¹ç»Ÿè®¡ ==="
        wc -l ipzy.txt || echo "æ— æ³•ç»Ÿè®¡è¡Œæ•°"
        echo "=== å‰20è¡Œé¢„è§ˆ ==="
        head -n 20 ipzy.txt || echo "æ— æ³•é¢„è§ˆæ–‡ä»¶"

    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ipzy.txt
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          git commit -m "Auto-update: Convert M3U to TXT - $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°"
        fi
